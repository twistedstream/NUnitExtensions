<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Choose>
    <!-- No build server - use default build number -->
    <When Condition=" '$(BUILD_NUMBER)' == '' ">
      <PropertyGroup>
        <Version_Build>0</Version_Build>
      </PropertyGroup>
    </When>
    <!-- Build number from build server passed in -->
    <Otherwise>
      <PropertyGroup>
        <Version_Build>$(BUILD_NUMBER)</Version_Build>
      </PropertyGroup>
    </Otherwise>
  </Choose>

  <!-- Generate AssemblyInfo files for projects -->
  <Target Name="GenAssemblyInfos">
    <Time>
      <Output TaskParameter="Year" PropertyName="Version_Year" />
    </Time>

    <!-- Construct version information -->
    <PropertyGroup>
      <Version_AssemblyVersion>$(Input_VersionMajor).$(Input_VersionMinor).$(Input_VersionRevision)</Version_AssemblyVersion>
      <Version_AssemblyFileVersion>$(Version_AssemblyVersion).$(Version_Build)</Version_AssemblyFileVersion>
      <Version_VersionInformationPadded Condition=" '$(Input_VersionInformation)' != '' "> $(Input_VersionInformation)</Version_VersionInformationPadded>
      <Version_AssemblyInformationalVersion>$(Version_AssemblyVersion)$(Version_VersionInformationPadded)</Version_AssemblyInformationalVersion>
      <Version_CompanyPadded> $(Input_Company)</Version_CompanyPadded>
      <Version_AssemblyCopyright>Copyright © $(Version_Year)$(Version_CompanyPadded) - All rights reserved.</Version_AssemblyCopyright>
      <Version_GeneratedAssemblyInfoFileName>AssemblyInfo.buildage.cs</Version_GeneratedAssemblyInfoFileName>
    </PropertyGroup>

    <Message Text="Common information that will be written to all $(Version_GeneratedAssemblyInfoFileName) files:" Importance="high" />
    <Message Text="- Assembly Version:       $(Version_AssemblyVersion)"/>
    <Message Text="- File Version:           $(Version_AssemblyFileVersion)"/>
    <Message Text="- Informational Version:  $(Version_AssemblyInformationalVersion)"/>
    <Message Text="- Copyright:              $(Version_AssemblyCopyright)"/>
    
    <!-- Build itemgroup with full path to generated AssemblyInfo files -->
    <ItemGroup>
        <Version_AssemblyInfoFiles Include="@(Input_ProjectDirs -> '%(FullPath)\$(Version_GeneratedAssemblyInfoFileName)')">
            <Title>%(AssemblyTitle)</Title>
            <Description>%(AssemblyDescription)</Description>
        </Version_AssemblyInfoFiles>
    </ItemGroup>
    
    <!-- Build each AssemblyInfo file in item group -->
    <Attrib Files="@(Version_AssemblyInfoFiles)" ReadOnly="False" />
    <AssemblyInfo CodeLanguage="CS"
                  OutputFile="@(Version_AssemblyInfoFiles)"
                  AssemblyTitle="%(Title)"
                  AssemblyDescription="%(Description)"
                  AssemblyCompany="$(Input_Company)"
                  AssemblyProduct="$(Input_Product)"
                  AssemblyCopyright="$(Version_AssemblyCopyright)"
                  AssemblyInformationalVersion="$(Version_AssemblyInformationalVersion)"
                  AssemblyVersion="$(Version_AssemblyVersion)"
                  AssemblyFileVersion="$(Version_AssemblyFileVersion)" />
  </Target>
</Project>